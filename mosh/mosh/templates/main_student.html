<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Main Student</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='main_student.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='notifications.css') }}">
</head>
<body>
	<div class="page">
		<div class="top">
			<div>
				<div class="hello">Привет, {{ student_name }}!</div>
				<div class="balance_row">
					Баланс: <span id="balance">{{ balance }}</span> ₽
					<button class="topup_btn" id="open_topup">+ Пополнить</button>
				</div>
			</div>

			<div class="top_right">
				{% if has_sub %}
				<button class="sub_btn sub_active" disabled>Абонемент куплен</button>
				{% else %}
				<button class="sub_btn" id="open_subscribe">Купить абонемент</button>
				{% endif %}
				{% include "_notifications_widget.html" %}
				<a class="logout" href="{{ url_for('logout') }}">Выйти</a>
			</div>
		</div>

		<div class="tabs">
			<div class="tab tab_active">Меню</div>
			<a class="tab" href="{{ url_for('orders_student') }}">Мои заказы</a>
			<a class="tab" href="{{ url_for('profile_student') }}">Профиль</a>
		</div>

		<div class="line"></div>

		<div class="grid">
			{% for d in dishes %}
			<a class="card" data-id="{{ d.id }}" href="{{ url_for('dish_page', dish_id=d.id) }}">
				<div class="tag tag_{{ d.category }}">{{ d.category_name }}</div>
				<div class="img" style="background-image:url('{{ d.image_url }}')"></div>

				<div class="card_body">
					<div class="row">
						<div class="card_title">{{ d.name }}</div>
						<div class="price">{{ d.price }} ₽</div>
					</div>
					<div class="desc">{{ d.short_desc }}</div>
<button class="pay_btn" type="button" onclick="window.location.href='{{ url_for('dish_page', dish_id=d.id) }}';">Оплатить</button>
				</div>
			</a>
			{% endfor %}
		</div>
	</div>

	<div class="overlay" id="overlay"></div>

	
	<div class="modal" id="topup_modal">
		<div class="modal_head">
			<div class="modal_title">Пополнение баланса</div>
			<button class="close">×</button>
		</div>
		<div class="modal_body">
			<input class="m_input" id="topup_card" placeholder="Номер карты (16 цифр)" inputmode="numeric">
			<input class="m_input" id="topup_exp" placeholder="MMYY (4 цифры)" inputmode="numeric">
			<input class="m_input" id="topup_cvc" placeholder="CVC (3 цифры)" inputmode="numeric">
			<input class="m_input" id="topup_amount" placeholder="Сумма">
			<button class="m_btn" id="topup_send">Пополнить</button>
		</div>
	</div>

	
	<div class="modal" id="sub_modal">
		<div class="modal_head">
			<div class="modal_title">Оформление абонемента</div>
			<button class="close">×</button>
		</div>
		<div class="modal_body">
			<div class="sub_row">
				Стоимость на 30 дней:
				<span class="sub_price">5000 ₽</span>
			</div>
			<div class="sub_actions">
				<button class="sub_cancel">Отмена</button>
				<button class="sub_buy">Купить</button>
			</div>
		</div>
	</div>

	
	<div class="modal" id="dish_modal">
		<div class="modal_head">
			<div class="modal_title" id="dish_title"></div>
			<button class="close">×</button>
		</div>
		<div class="modal_body">
			<div class="dish_img" id="dish_img"></div>
			<div class="dish_desc" id="dish_desc"></div>

			<div class="nutri">
				<div><div class="nutri_label">Ккал</div><div id="kcal"></div></div>
				<div><div class="nutri_label">Белки</div><div id="p"></div></div>
				<div><div class="nutri_label">Жиры</div><div id="f"></div></div>
				<div><div class="nutri_label">Углеводы</div><div id="c"></div></div>
			</div>

			<button class="m_btn" id="dish_buy">Оплатить</button>
		</div>
	</div>

	<script>
		let currentDish = null

		const overlay = document.getElementById("overlay")
		const balanceEl = document.getElementById("balance")
		const topupModal = document.getElementById("topup_modal")
		const subModal = document.getElementById("sub_modal")
		const dishModal = document.getElementById("dish_modal")
		const topupAmountEl = document.getElementById("topup_amount")
		const topupPhoneEl = document.getElementById("topup_phone")
		function show(m){ overlay.style.display="block"; m.style.display="block" }
		function hide(){
			overlay.style.display="none"
			document.querySelectorAll(".modal").forEach(m=>m.style.display="none")
			currentDish = null
		}

		document.querySelectorAll(".close, .sub_cancel").forEach(b=>b.onclick=hide)
		overlay.onclick = hide

		const openTopupBtn = document.getElementById("open_topup")
		if(openTopupBtn) openTopupBtn.onclick = () => show(topupModal)
		const openSubscribeBtn = document.getElementById("open_subscribe")
		if(openSubscribeBtn) openSubscribeBtn.onclick = () => show(subModal)

		async function post(url, data={}){
			const r = await fetch(url,{
				method:"POST",
				headers:{ "Content-Type":"application/json" },
				body:JSON.stringify(data)
			})
			return r.json()
		}

		document.getElementById("topup_send").onclick = async ()=>{
			const amount = Number(topupAmountEl.value||0)
			const card = String(document.getElementById("topup_card").value||"").replace(/\s+/g,"")
			const exp  = String(document.getElementById("topup_exp").value||"").replace(/\s+/g,"")
			const cvc  = String(document.getElementById("topup_cvc").value||"").replace(/\s+/g,"")

			if(!/^\d{16}$/.test(card)) return alert("Номер карты должен быть 16 цифр")
			if(!/^\d{4}$/.test(exp)) return alert("Дата должна быть 4 цифры (MMYY)")
			if(!/^\d{3}$/.test(cvc)) return alert("CVC должен быть 3 цифры")
			if(!(amount>0)) return alert("Введите сумму")

			const res = await post("/api/topup",{amount, card_number:card, exp, cvc})
			if(res.ok){
				balanceEl.textContent = res.balance
				hide()
			}else alert(res.error)
		}



		const subBtn = document.getElementById("open_subscribe")

		document.querySelector(".sub_buy").onclick = async ()=>{
			const res = await post("/api/subscribe")
			if(res.ok){
				balanceEl.textContent = res.balance

				if(subBtn){
					subBtn.textContent = "Абонемент куплен"
					subBtn.classList.add("sub_active")
					subBtn.disabled = true
				}

				hide()
			}else{
				alert(res.error)
			}
		}


		document.querySelectorAll(".card").forEach(card=>{
			card.onclick = async ()=>{
				const id = card.dataset.id
				const d = await fetch("/api/dish/"+id).then(r=>r.json())
				if(!d.ok) return alert(d.error)

				currentDish = id
				dish_title.textContent = d.name
				dish_desc.textContent = d.description
				dish_img.style.backgroundImage = `url('${d.image_url}')`
				kcal.textContent = d.kcal
				p.textContent = d.protein
				f.textContent = d.fat
				c.textContent = d.carbs
				dish_buy.textContent = d.free ? "Бесплатно" : "Оплатить"
				show(dishModal)
			}
		})

		document.getElementById("dish_buy").onclick = async ()=>{
			if(!currentDish) return
			const res = await post("/api/buy/"+currentDish)
			if(res.ok){
				balanceEl.textContent = res.balance
				hide()
				alert(res.free ? "Получено бесплатно" : "Блюдо оплачено")
			}else alert(res.error)
		}
	</script>
	<script src="{{ url_for('static', filename='notifications.js') }}"></script>
</body>
</html>
