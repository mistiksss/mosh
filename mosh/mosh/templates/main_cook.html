<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Повар</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='cook.css') }}">
</head>
<body>
	<main>
		<div class="wrap">
			<div class="top">
				<div class="h">Заказы (готовятся)</div>
				<a class="logout" href="{{ url_for('logout') }}">Выйти</a>
			</div>

			{% if orders|length == 0 %}
				<div class="empty">Нет заказов</div>
			{% else %}
				<div class="list">
					{% for o in orders %}
					<div class="card">
						<div class="left">
							<div class="t">{{ o.dish.name }}</div>
							<div class="s">Заказ №{{ o.id }} • Ученик: {{ o.user.username }}</div>
						</div>
						<button class="doneOrder" data-id="{{ o.id }}">Заказ сделан</button>
					</div>
					{% endfor %}
				</div>
			{% endif %}

			<div class="sep"></div>
			<div class="h" style="margin-top:10px">Заявка на закупку</div>
			<div class="form">
				<input id="prTitle" placeholder="Название (например, Овощи, молоко)" />
				<input id="prAmount" type="number" min="1" placeholder="Сумма (₽)" />
				<input id="prDesc" placeholder="Комментарий (необязательно)" />
			<button id="prSend" class="doneOrder" style="width: fit-content">Отправить</button>
			</div>
			<div id="prMsg" class="empty" style="display:none"></div>
		</div>
	</main>

	<script>
		async function post(url){
			const r = await fetch(url, {method:"POST"})
			return r.json()
		}

		document.querySelectorAll(".doneOrder[data-id]").forEach(b=>{
			b.onclick = async ()=>{
				const id = b.getAttribute("data-id")
				const res = await post(`/api/order/${id}/done`)
				if(res.ok) location.reload()
			}
		})

		async function postJSON(url, body){
			const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})})
			return r.json()
		}
		const prSend = document.getElementById('prSend')
		if(prSend){
			prSend.onclick = async ()=>{
				const title = document.getElementById('prTitle').value
				const amount = document.getElementById('prAmount').value
				const description = document.getElementById('prDesc').value
				const res = await postJSON('/api/cook/purchase_requests', {title, amount, description})
				const msg = document.getElementById('prMsg')
				if(res.ok){
					msg.textContent = 'Заявка отправлена администратору'
					msg.style.display = ''
					document.getElementById('prTitle').value=''
					document.getElementById('prAmount').value=''
					document.getElementById('prDesc').value=''
				} else {
					msg.textContent = res.error || 'Ошибка'
					msg.style.display = ''
				}
			}
		}
	</script>
</body>
</html>
