<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ dish.name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='main_student.css') }}">
</head>
<body>
  <div class="page">
    <div class="top">
      <div>
        <div class="hello">{{ dish.name }}</div>
        <div style="margin-top:8px;">
          <a href="{{ url_for('main_student') }}" style="text-decoration:none;">← Назад к меню</a>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card" style="max-width:720px; margin:0 auto;">
        <div class="img" style="background-image:url('{{ dish.image_url }}'); height:260px;"></div>
        <div class="card_body">
          <div class="row">
            <div class="card_title">{{ dish.name }}</div>
            <div class="price">{{ dish.price }} ₽</div>
          </div>
          <div class="desc" style="margin-top:8px;">{{ dish.description }}</div>

          <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
            <div>Ккал: <b>{{ dish.kcal }}</b></div>
            <div>Б: <b>{{ dish.protein }}</b></div>
            <div>Ж: <b>{{ dish.fat }}</b></div>
            <div>У: <b>{{ dish.carbs }}</b></div>
          </div>

          <div style="margin-top:16px;">
            <button class="pay_btn" onclick="buyDish({{ dish.id }})">Оплатить</button>
          </div>

          <div style="margin-top:22px; opacity:.75;">
            {{ reviews|length }} отзыв(ов).
          <div style="margin-top:10px;">
            {% if reviews %}
              <div style="display:flex; flex-direction:column; gap:12px;">
                {% for r in reviews %}
                  <div style="border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px;">
                    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                      <div style="font-weight:600;">{{ r.user.username }}</div>
                      <div style="opacity:.8;">Оценка: <b>{{ r.rating }}</b>/5</div>
                    </div>
                    <div style="margin-top:6px;">{{ r.text }}</div>
                    <div style="margin-top:6px; font-size:12px; opacity:.6;">{{ r.created_at.strftime("%d.%m.%Y %H:%M") if r.created_at else "" }}</div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div style="opacity:.75;">Пока нет отзывов.</div>
            {% endif %}
          </div>

          <div style="margin-top:18px;">
            {% if can_review %}
              <div style="font-weight:700; margin-bottom:8px;">Оставить отзыв</div>
              <form id="reviewForm" onsubmit="submitReview(event)">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <label>Рейтинг:
                    <select id="reviewRating" required>
                      {% for i in range(1,6) %}
                        <option value="{{ i }}" {% if my_review and my_review.rating==i %}selected{% endif %}>{{ i }}</option>
                      {% endfor %}
                    </select>
                  </label>
                </div>
                <div style="margin-top:8px;">
                  <textarea id="reviewText" rows="4" style="width:100%; resize:vertical;" required>{{ my_review.text if my_review else "" }}</textarea>
                </div>
                <div style="margin-top:10px;">
                  <button class="pay_btn" type="submit" onclick="event.stopPropagation();">Отправить</button>
                </div>
              </form>
            {% else %}
              <div style="opacity:.75;">Оставить отзыв можно только после получения блюда.</div>
            {% endif %}
          </div>

          </div>
        </div>
      </div>
    </div>
  </div>

<script>
async function buyDish(dishId){
  const resp = await fetch(`/api/buy/${dishId}`, {method:"POST"});
  let data = null;
  const ct = resp.headers.get("content-type") || "";
  if (ct.includes("application/json")) data = await resp.json();
  else data = {ok:false, error: await resp.text()};

  if (!resp.ok || !data.ok){
    alert(data.error || "Ошибка оплаты");
    return;
  }
  alert("Заказ создан");
  window.location.href = "{{ url_for('main_student') }}";
}

async function submitReview(e){
  e.preventDefault();
  const rating = parseInt(document.getElementById("reviewRating").value);
  const text = document.getElementById("reviewText").value;

  const resp = await fetch(`/api/reviews/{{ dish.id }}`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({rating: rating, text: text})
  });

  let data = null;
  const ct = resp.headers.get("content-type") || "";
  if (ct.includes("application/json")) data = await resp.json();
  else data = {ok:false, error: await resp.text()};

  if (!resp.ok || !data.ok){
    alert(data.error || "Ошибка");
    return;
  }
  alert("Отзыв сохранён");
  location.reload();
}
</script>
</body>
</html>
