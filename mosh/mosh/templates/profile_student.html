<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Профиль</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='profile_student.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='notifications.css') }}">
</head>
<body>
  <div class="page">
    <div class="top">
      <div>
        <div class="hello">Привет, {{ student_name }}!</div>
        <div class="balance_row">
          Баланс: <span class="balance_value">{{ balance }}</span> ₽
          <a class="mini_link" href="{{ url_for('main_student') }}">Меню</a>
        </div>
      </div>

      <div class="top_right">
        {% if has_sub %}
          <button class="sub_btn sub_active" disabled>Абонемент куплен</button>
        {% else %}
          <a class="sub_btn" href="{{ url_for('main_student') }}">Купить абонемент</a>
        {% endif %}
        {% include "_notifications_widget.html" %}
        <a class="logout" href="{{ url_for('logout') }}">Выйти</a>
      </div>
    </div>

    <div class="tabs">
      <a class="tab" href="{{ url_for('main_student') }}">Меню</a>
      <a class="tab" href="{{ url_for('orders_student') }}">Мои заказы</a>
      <div class="tab tab_active">Профиль</div>
    </div>
    <div class="line"></div>

    <div class="panel">
      <div class="card">
        <div class="block_title">Аллергены</div>
        <div class="chips" id="allergens">
          <button class="chip" data-key="nuts">Орехи</button>
          <button class="chip" data-key="lactose">Лактоза</button>
          <button class="chip" data-key="gluten">Глютен</button>
          <button class="chip" data-key="fish">Рыба</button>
          <button class="chip" data-key="eggs">Яйца</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const selected = new Set({{ selected_allergens|tojson }});
    const chips = document.querySelectorAll("#allergens .chip");

    function render(){
      chips.forEach(b=>{
        const k = b.dataset.key;
        b.classList.toggle("chip_active", selected.has(k));
      });
    }
    render();

    let saveTimer = null;

    async function save(){
      await fetch("/api/profile/allergens", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ allergens: Array.from(selected) })
      });
    }

    chips.forEach(b=>{
      b.onclick = ()=>{
        const k = b.dataset.key;
        if(selected.has(k)) selected.delete(k);
        else selected.add(k);
        render();

        clearTimeout(saveTimer);
        saveTimer = setTimeout(save, 250);
      };
    });
  </script>
  <script src="{{ url_for('static', filename='notifications.js') }}"></script>

</body>
</html>
