<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Админ-панель</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='notifications.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .reportBox{margin-top:12px; display:flex; flex-direction:column; gap:10px;}
    .textarea{width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.08); color:#fff; font:inherit; resize:vertical;}
    .textarea::placeholder{color:rgba(255,255,255,.6);}
    .reportActions{display:flex; justify-content:flex-end;}
    .reportListTitle{margin-top:6px; font-weight:700;}
    .listItem{border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:12px; background:rgba(255,255,255,.06);}
    .muted{opacity:.7; font-size:12px;}
  </style>
</head>
<body>
  <main>
    <div class="wrap">
      <div class="header">
        <div>
          <div class="title">Админ-панель</div>
          <div class="subtitle">Учет и аналитика</div>
        </div>
        <div class="headerRight" style="display:flex;align-items:center;gap:12px;">
          {% include "_notifications_widget.html" %}
          <a class="logout" href="{{ url_for('logout') }}">Выйти</a>
        </div>
      </div>

      <div class="cards">
        <div class="card blue">
          <div class="label">ВЫРУЧКА</div>
          <div class="value" id="rev">0 ₽</div>
        </div>
        <div class="card red">
          <div class="label">РАСХОДЫ</div>
          <div class="value" id="exp">0 ₽</div>
        </div>
        <div class="card green">
          <div class="label">ПРИБЫЛЬ</div>
          <div class="value" id="prof">0 ₽</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="stats">Статистика</button>
        <button class="tab" data-tab="reports">Отчёты</button>
        <button class="tab" data-tab="req">Заявки (<span id="reqCount">0</span>)</button>
        <div class="spacer"></div>
        <div class="range">
          <input type="date" id="from">
          <span>—</span>
          <input type="date" id="to">
          <button class="btn" id="apply">Применить</button>
        </div>
      </div>

      <section id="tab-stats" class="panel">
        <div class="panelHead">
          <div class="panelTitle">Статистика оплат и посещаемости</div>
          <div class="actions">
            </div>
        </div>
        <div class="chartBox">
          <canvas id="chart"></canvas>
        </div>
        <div class="hint">Синий: выручка, красный: расходы, оранжевый: посещаемость.</div>
      </section>

      
      <section id="tab-reports" class="panel" style="display:none">
        <div class="panelHead">
          <div class="panelTitle">Отчёты по питанию и затратам</div>
          <div class="actions"></div>
        </div>

        <div class="reportBox">
          <textarea id="reportText" class="textarea" rows="6" placeholder="Введите текст отчёта..."></textarea>
          <div class="reportActions">
            <button class="btn" id="sendReportBtn">Сохранить</button>
          </div>

          <div class="reportListTitle">Сохранённые отчёты</div>
          <div id="reportsList" class="list"></div>
          <div id="reportsEmpty" class="empty" style="display:none">Пока нет отчётов</div>
        </div>
      </section>

<section id="tab-req" class="panel" style="display:none">
        <div class="panelHead">
          <div class="panelTitle">Согласование заявок на закупки</div>
          <div class="actions">
            <select id="reqFilter" class="select">
              <option value="pending">Ожидают</option>
              <option value="approved">Согласованные</option>
              <option value="rejected">Отклоненные</option>
            </select>
          </div>
        </div>
        <div id="reqList" class="list"></div>
        <div id="reqEmpty" class="empty" style="display:none">Нет активных заявок</div>
      </section>
    </div>
  </main>

  <script>
    const fmt = n => (Number(n||0)).toLocaleString('ru-RU') + ' ₽'
    const $ = (id)=>document.getElementById(id)

    let chart;

    function isoToday(){
      const d = new Date();
      const pad = (x)=>String(x).padStart(2,'0')
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`
    }
    function isoDaysAgo(days){
      const d = new Date();
      d.setDate(d.getDate()-days);
      const pad = (x)=>String(x).padStart(2,'0')
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`
    }

    async function getJSON(url){
      const r = await fetch(url);
      return r.json();
    }
    async function postJSON(url, body){
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})});
      return r.json();
    }

    async function loadStats(){
      const from = $('from').value;
      const to = $('to').value;
      
      const data = await getJSON(`/api/admin/stats?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
      if(!data.ok) return;

      $('rev').textContent = fmt(data.revenue);
      $('exp').textContent = fmt(data.expenses);
      $('prof').textContent = fmt(data.profit);

      const labels = data.series.map(x=>x.day);
      const rev = data.series.map(x=>x.revenue);
      const exp = data.series.map(x=>x.expenses);
      const att = data.series.map(x=>x.attendance);

      const ctx = $('chart');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label:'Выручка', data: rev, tension: 0.2 },
            { label:'Расходы', data: exp, tension: 0.2 },
            { label:'Посещаемость', data: att, tension: 0.2, yAxisID:'y2' },
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: { beginAtZero:true, ticks: { callback: (v)=> v + ' ₽' } },
            y2: { beginAtZero:true, position:'right', grid:{ drawOnChartArea:false } }
          }
        }
      });
    }

    function reqCard(pr){
      const el = document.createElement('div');
      el.className = 'reqCard';
      el.innerHTML = `
        <div class="reqMain">
          <div class="reqTitle">${escapeHtml(pr.title)}</div>
          <div class="reqMeta">${escapeHtml(pr.created_by||'')} • ${new Date(pr.created_at).toLocaleString('ru-RU')} • ${pr.amount}</div>
        </div>
        <div class="reqActions"></div>
      `;

      const actions = el.querySelector('.reqActions');
      if(pr.status === 'pending'){
        const a = document.createElement('button');
        a.className = 'btn ok';
        a.textContent = 'Согласовать';
        a.onclick = async ()=>{
          const r = await postJSON(`/api/admin/purchase_requests/${pr.id}/decision`, {decision:'approved'});
          if(r.ok) await loadRequests();
        };
        const b = document.createElement('button');
        b.className = 'btn bad';
        b.textContent = 'Отклонить';
        b.onclick = async ()=>{
          const r = await postJSON(`/api/admin/purchase_requests/${pr.id}/decision`, {decision:'rejected'});
          if(r.ok) await loadRequests();
        };
        actions.appendChild(a);
        actions.appendChild(b);
      } else {
        const s = document.createElement('div');
        s.className = 'status ' + pr.status;
        s.textContent = pr.status === 'approved' ? 'Согласовано' : 'Отклонено';
        actions.appendChild(s);
      }
      return el;
    }

    function escapeHtml(s){
      return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    async function loadRequests(){
      const status = $('reqFilter').value;
      const data = await getJSON(`/api/admin/purchase_requests?status=${encodeURIComponent(status)}`);
      if(!data.ok) return;
      const list = $('reqList');
      list.innerHTML = '';
      const pending = await getJSON('/api/admin/purchase_requests?status=pending');
      $('reqCount').textContent = pending.ok ? pending.items.length : 0;
      if(data.items.length === 0){
        $('reqEmpty').style.display = '';
      } else {
        $('reqEmpty').style.display = 'none';
        data.items.forEach(pr=> list.appendChild(reqCard(pr)));
      }
    }

    document.querySelectorAll('.tab').forEach(b=>{
      b.onclick = ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const t = b.getAttribute('data-tab');
        $('tab-stats').style.display = t==='stats' ? '' : 'none';
        $('tab-reports').style.display = t==='reports' ? '' : 'none';
        $('tab-req').style.display = t==='req' ? '' : 'none';
        if(t==='stats') loadStats();
        if(t==='reports') loadReports();
        if(t==='req') loadRequests();
      };
    });

    $('reqFilter').onchange = loadRequests;
    $('apply').onclick = ()=>{ loadStats(); loadRequests(); };

    $('to').value = isoToday();
    $('from').value = isoDaysAgo(29);
    loadStats();
    loadRequests();
  
    function escHtml(s){
      return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    async function loadReports(){
      const box = $("reportsList");
      const empty = $("reportsEmpty");
      if (!box || !empty) return;

      box.innerHTML = "";
      empty.style.display = "none";

      const data = await getJSON("/api/admin/reports");
      if(!data.ok){
        empty.style.display = "block";
        empty.textContent = data.error || "Ошибка загрузки отчётов";
        return;
      }
      if(!data.items || data.items.length===0){
        empty.style.display = "block";
        return;
      }
      data.items.forEach(r=>{
        const el = document.createElement("div");
        el.className = "listItem";
        el.innerHTML = `<div class="muted">${r.created_at || ""}</div><div style="margin-top:6px; white-space:pre-wrap;">${escHtml(r.text)}</div>`;
        box.appendChild(el);
      });
    }

    async function sendReport(){
      const ta = $("reportText");
      if(!ta) return;
      const text = (ta.value||"").trim();
      if(!text){ alert("Введите текст отчёта"); return; }

      const data = await postJSON("/api/admin/reports", {text});
      if(!data.ok){ alert(data.error || "Ошибка"); return; }
      ta.value="";
      await loadReports();
    }

    document.addEventListener("click",(e)=>{
      const btn = e.target.closest && e.target.closest("#sendReportBtn");
      if(btn) sendReport();
    });

</script>
<script src="{{ url_for('static', filename='notifications.js') }}"></script>
</body>
</html>
