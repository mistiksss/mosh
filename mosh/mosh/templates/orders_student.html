<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Мои заказы</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='orders_student.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='notifications.css') }}">
</head>
<body>
	<header>
		<div class="left">
			<div class="hello">Привет, {{ student_name }}!</div>
			<div class="balance_row">
				<div class="balance">Баланс: <span id="bal">{{ balance }}</span> ₽</div>
				<button class="topup_btn" id="open_topup">+ Пополнить</button>
			</div>
		</div>

		<div class="right">
			{% if has_sub %}
				<button class="sub_btn sub_active" disabled>Абонемент куплен</button>
			{% else %}
				<button class="sub_btn" id="open_subscribe">Купить абонемент</button>
			{% endif %}
			{% include "_notifications_widget.html" %}
			<a class="logout" href="{{ url_for('logout') }}">Выйти</a>
		</div>
	</header>

	<main>
		<div class="tabs">
			<a class="tab" href="{{ url_for('main_student') }}">Меню</a>
			<a class="tab tab_active" href="{{ url_for('orders_student') }}">Мои Заказы</a>
			<a class="tab" href="{{ url_for('profile_student') }}">Профиль</a>
		</div>

		<div class="line"></div>

		{% if orders|length == 0 %}
			<div class="empty_box">
				<div class="empty_text">У вас пока нет заказов</div>
			</div>
		{% else %}
			<div class="orders_list">
				{% for o in orders %}
				<div class="order_card">
					<div class="order_left">
						<div class="order_title">{{ o.dish.name }}</div>
						<div class="order_sub">
							№{{ o.id }} • {{ o.created_at.strftime('%d.%m.%Y %H:%M') if o.created_at else '' }}
						</div>
					</div>

					<div class="order_right">
						{% if o.status == "preparing" %}
							<div class="badge badge_wait">Готовится</div>
							<button class="pick_btn" disabled>Получить</button>
						{% elif o.status == "issued" %}
							<div class="badge badge_ready">Выдано</div>
							<button class="pick_btn" data-id="{{ o.id }}">Получено</button>
						{% else %}
							<div class="badge badge_done">Получено</div>
							<button class="pick_btn" disabled>Получено</button>
						{% endif %}
					</div>
				</div>
				{% endfor %}
			</div>
		{% endif %}
	</main>

	<script>
		async function post(url, body){
			const res = await fetch(url, {
				method: "POST",
				headers: {"Content-Type":"application/json"},
				body: JSON.stringify(body || {})
			})
			return res.json()
		}

		document.querySelectorAll(".pick_btn[data-id]").forEach(btn=>{
			btn.onclick = async ()=>{
				const id = btn.getAttribute("data-id")
				const r = await post(`/api/order/${id}/pickup`)
				if(r.ok){
					location.reload()
				}
			}
		})
	</script>
	<script src="{{ url_for('static', filename='notifications.js') }}"></script>
</body>
</html>
